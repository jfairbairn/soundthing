<!DOCTYPE html> 
<html> 
<head> 
	<meta charset="utf-8" /> 
	<title>SoundThing</title> 
	<link rel="stylesheet"  href="css/jquery.mobile-1.0a3.min.css" />
	<script type="text/javascript" src="js/jquery-1.5.min.js"></script> 
	<script type="text/javascript" src="js/jquery.mobile-1.0a3.min.js"></script>
	<script type="text/javascript" src="js/jquery.cookie.js"></script>
	<meta name="viewport" content="width=device-width, user-scalable=no" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
</head> 
<body> 
  
  <div data-role="page" data-theme="b" id="st-checkin">

  	<div data-role="header">
  	  <a href="index.html" data-icon="back" data-theme="b">Back</a>
  		<h1>Check in</h1>
  	</div>

  	<div data-role="content">	
  		
  		<article> 
        <p>Finding your location: <span id="status">checking...</span></p> 
        <div id="mapcanvas" style="width:100%; height:200px;"></div>
      </article>
      
      <div class="result">
        
      </div>
      
      <script> 
  		function sendlocation(lat, lng) {
  		  query = "lat="+lat+"&lon="+lng;
        //console.log(query);
        $.ajax({
          type: 'POST',
          //url: "/location/tom/"+lat+"/"+lon,
          url: "/location/tom",
          data: query,
          success: function(data) {
            displaymap(lat, lng);
            console.log(data);
          },
          error: function(data) {
          }
        });
        
        
  		}
  		
  		function displaymap(lat, lng) {
        // Show mobile webkit compatable map here if we want
  		}
  		
      function success(position) {
        var s = document.querySelector('#status');

        if (s.className == 'success') {
          // not sure why we're hitting this twice in FF, I think it's to do with a cached result coming back    
          return;
        }

        s.innerHTML = "found you!";
        s.className = 'success';
        
        sendlocation(position.coords.latitude, position.coords.longitude);
        
      }

      function error(msg) {
        var s = document.querySelector('#status');
        s.innerHTML = typeof msg == 'string' ? msg : "failed";
        s.className = 'fail';

        // console.log(arguments);
      }
      
      // Are we running a Geo Location capable browser?
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(success, error);
      } else {
        error('not supported');
      }

      </script>

      <script>
    	  $(document).ready(function() {
          if ($.cookie("spotifyname") == null) {
            window.location="index.html";
          }
        });
      </script>
  				
  	</div>

  </div>
 
</body> 
</html>