<!DOCTYPE html> 
<html> 
<head> 
	<meta charset="utf-8" /> 
	<title>SoundThing</title> 
	<link rel="stylesheet"  href="css/jquery.mobile-1.0a3.min.css" />
	<script type="text/javascript" src="js/jquery-1.5.min.js"></script> 
	<script type="text/javascript" src="js/jquery.mobile-1.0a3.min.js"></script>
	<meta name="viewport" content="width=device-width, user-scalable=no" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
</head> 
<body> 
  
  <div data-role="page" data-theme="b" id="st-checkin">

  	<div data-role="header">
  	  <a href="index.html" data-icon="back" data-theme="b">Back</a>
  		<h1>Checkin</h1>
  	</div>

  	<div data-role="content">	
  		
  		<div class="article"> 
        <p>Finding your location: <span id="status">checking...</span></p> 
      </div>
      
      <div class="result">
      </div>
      
      <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
  		<script> 
  		function sendlocation(lat, lng) {
  		  query = "lat="+lat+"&lon="+lng;
        //console.log(query);
        $.ajax({
          type: 'POST',
          //url: "/location/tom/"+lat+"/"+lon,
          url: "/location/tom",
          data: query,
          success: function(msg) {
            $('.result').html("Yay!");
            //console.log(msg);
          },
          error: function(msg) {
            $('.result').html("Error!");
            //console.log(msg);
          }
        });
        
        
  		}
  		
      function success(position) {
        var s = document.querySelector('#status');

        if (s.className == 'success') {
          // not sure why we're hitting this twice in FF, I think it's to do with a cached result coming back    
          return;
        }

        s.innerHTML = "found you!";
        s.className = 'success';
        
        var mapcanvas = document.createElement('div');
        mapcanvas.id = 'mapcanvas';
        mapcanvas.style.height = '200px';
        mapcanvas.style.width = '100%';

        document.querySelector('.article').appendChild(mapcanvas);

        var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
        var myOptions = {
          zoom: 15,
          center: latlng,
          mapTypeControl: false,
          navigationControlOptions: {style: google.maps.NavigationControlStyle.SMALL},
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        var map = new google.maps.Map(document.getElementById("mapcanvas"), myOptions);

        var marker = new google.maps.Marker({
            position: latlng, 
            map: map, 
            title:"You are here!"
        });
        
        sendlocation(position.coords.latitude, position.coords.longitude);
      }

      function error(msg) {
        var s = document.querySelector('#status');
        s.innerHTML = typeof msg == 'string' ? msg : "failed";
        s.className = 'fail';

        // console.log(arguments);
      }
      
      // Are we running a Geo Location capable browser?
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(success, error);
      } else {
        error('not supported');
      }

      </script>
  				
  	</div>

  </div>
 
</body> 
</html>